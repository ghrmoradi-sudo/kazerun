<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نوسازی مسکن در بافت فرسوده کازرون</title>
    <!-- Leaflet CSS for map functionality -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <!-- Leaflet.markercluster CSS for clustering styles -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css" />
    <!-- Tailwind CSS for modern and responsive styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* تعیین اندازه نقشه به اندازه کامل صفحه نمایش */
        #map {
            width: 100vw;
            height: 100vh;
        }

        /* استایل سفارشی برای آیکون‌های مارکر سفارشی */
        .custom-marker-icon {
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            border: 2px solid white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
            transition: all 0.2s ease-in-out;
        }
        
        .custom-marker-icon svg {
            filter: drop-shadow(0 1px 1px rgba(0,0,0,0.2));
            transition: transform 0.2s ease-in-out;
        }
        
        /* استایل سفارشی برای پاپ‌آپ Leaflet */
        .leaflet-popup-content-wrapper {
            border-radius: 12px;
            box-shadow: 0 6px 20px rgba(0,0,0,0.15);
            padding: 0;
        }

        .popup-content {
            background-color: white;
            padding: 1rem;
            border-radius: 12px;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            direction: rtl;
            text-align: right;
        }
        
        .popup-title {
            font-size: 1.25rem;
            font-weight: bold;
            color: #1f2937;
            border-bottom: 2px solid #e5e7eb;
            padding-bottom: 0.75rem;
            margin-bottom: 0.75rem;
        }
        
        .popup-info-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        
        .popup-info-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 0;
            border-bottom: 1px dashed #e5e7eb;
        }
        
        .popup-info-item:last-child {
            border-bottom: none;
        }
        
        .popup-label {
            font-weight: 500;
            color: #4b5563;
        }
        
        .popup-value {
            color: #1f2937;
        }

        /* استایل برای آیکون‌های پاپ‌آپ */
        .popup-icon {
            display: inline-block;
            margin-left: 0.5rem;
            color: #4b5563;
        }

        /* استایل برای راهنما */
        .legend {
            background-color: white;
            padding: 1rem;
            border-radius: 12px;
            box-shadow: 0 6px 20px rgba(0,0,0,0.15);
            position: absolute;
            top: 10px;
            left: 10px;
            z-index: 1000;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            direction: rtl;
            text-align: right;
        }

        .legend-title {
            font-weight: bold;
            margin-bottom: 0.5rem;
            font-size: 1rem;
            color: #1f2937;
        }

        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 0.25rem;
            font-size: 0.875rem;
            color: #4b5563;
        }

        .legend-color-box {
            width: 15px;
            height: 15px;
            margin-left: 0.5rem;
            border-radius: 4px;
        }

        /* استایل برای برچسب‌های محلات */
        .neighborhood-label {
            font-size: 1rem;
            font-weight: bold;
            color: rgba(0, 0, 0, 0.4); /* رنگ خاکستری کم‌رنگ */
            text-shadow: 1px 1px 2px rgba(255, 255, 255, 0.8);
            text-align: center;
            white-space: nowrap;
            opacity: 0; /* در ابتدا مخفی است */
            transition: opacity 0.5s ease-in-out;
        }
        .neighborhood-label.visible {
            opacity: 1; /* در زوم مناسب نمایش داده می‌شود */
        }
        
        /* استایل برای برچسب‌های تعداد */
        .count-label {
            font-size: 1.25rem;
            font-weight: bold;
            color: #000;
            text-shadow: 2px 2px 3px rgba(255, 255, 255, 0.8);
            text-align: center;
            white-space: nowrap;
        }

    </style>
</head>
<body>

    <div id="map"></div>

    <div class="legend">
        <div class="legend-title">سال نوسازی</div>
        <div class="legend-item">
            <div class="legend-color-box" style="background-color: #ff0000;"></div>
            <span>1399</span>
        </div>
        <div class="legend-item">
            <div class="legend-color-box" style="background-color: #ff7b00;"></div>
            <span>1400</span>
        </div>
        <div class="legend-item">
            <div class="legend-color-box" style="background-color: #ffec00;"></div>
            <span>1401</span>
        </div>
        <div class="legend-item">
            <div class="legend-color-box" style="background-color: #00ff00;"></div>
            <span>1402</span>
        </div>
        <div class="legend-item">
            <div class="legend-color-box" style="background-color: #0000ff;"></div>
            <span>1403</span>
        </div>
    </div>


    <!-- Leaflet JavaScript Library -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <!-- Leaflet.markercluster JavaScript Library -->
    <script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>
    <!-- Turf.js for calculating polygon centers -->
    <script src="https://unpkg.com/@turf/turf@6.5.0/turf.min.js"></script>

    <script>
        // تعریف نقشه و مرکز اولیه
        const نقشه = L.map('map').setView([29.62, 51.68], 13);
        
        let لایه_چندضلعی_ها = null; // لایه محلات
        let لایه_نقاط = null;       // لایه قطعات نوسازی شده
        let لایه_برچسب_ها = L.layerGroup(); // لایه برای نمایش نام محلات
        let لایه_تعداد_ها = L.layerGroup(); // لایه برای نمایش تعداد قطعات

        // اضافه کردن لایه نقشه پایه از OpenStreetMap
        L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
        }).addTo(نقشه);

        // پالت رنگی برای سال‌های نوسازی
        const رنگ_سالها = {
            '1399': '#ff0000', // قرمز
            '1400': '#ff7b00', // نارنجی
            '1401': '#ffec00', // زرد
            '1402': '#00ff00', // سبز
            '1403': '#0000ff', // آبی
            'default': '#808080' // خاکستری برای سال‌های نامشخص
        };

        // پالت رنگی برای محلات
        const رنگهای_محلات = {};
        const رنگها_پیشفرض = ['#e6194B', '#3cb44b', '#ffe119', '#4363d8', '#f58231', '#911eb4', '#42d4f4', '#f032e6', '#bfef45', '#fabed4', '#aaffc3', '#469990'];
        let شاخص_رنگ = 0;

        // تابع کمکی برای گرفتن رنگ بر اساس سال
        function گرفتن_رنگ_سال(سال) {
            return رنگ_سالها[سال] || رنگ_سالها['default'];
        }
        
        // تابع برای ایجاد آیکون مارکر پویا بر اساس سال و سطح زوم
        function ایجاد_آیکون_سال(ویژگی, زوم_فعلی) {
            const سال = ویژگی.properties.year;
            const رنگ = گرفتن_رنگ_سال(String(سال));
            
            // تنظیم اندازه آیکون بر اساس زوم: هرچه زوم بیشتر، آیکون بزرگ‌تر
            const اندازه_پایه = 16; 
            const اندازه = اندازه_پایه * Math.pow(1.2, زوم_فعلی - 13); // از تابع نمایی برای تغییر اندازه استفاده می‌کنیم

            return L.divIcon({
                className: 'custom-marker-icon',
                html: `<svg style="width:100%; height:100%; color:${رنگ};" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/>
                    </svg>`,
                iconSize: [اندازه, اندازه],
                iconAnchor: [اندازه / 2, اندازه],
                popupAnchor: [0, -اندازه]
            });
        }
        
        // تابع برای ایجاد برچسب نام محله
        function ایجاد_برچسب_محله(ویژگی) {
            if (ویژگی.properties && ویژگی.properties.name) {
                const نام_محله = ویژگی.properties.name;
                // محاسبه مرکز چندضلعی با استفاده از turf.js
                const مرکز = turf.center(ویژگی.geometry);
                const مختصات = [مرکز.geometry.coordinates[1], مرکز.geometry.coordinates[0]];
                
                const برچسب_آیکون = L.divIcon({
                    className: 'neighborhood-label',
                    html: `<div>${نام_محله}</div>`,
                    iconSize: [100, 20],
                    iconAnchor: [50, 10]
                });
                
                const برچسب_مارکر = L.marker(مختصات, { icon: برچسب_آیکون, interactive: false });
                لایه_برچسب_ها.addLayer(برچسب_مارکر);
            }
        }
        
        // تابع برای ایجاد برچسب تعداد قطعات نوسازی شده
        function ایجاد_برچسب_تعداد(نام_محله, تعداد, مرکز) {
            const برچسب_آیکون = L.divIcon({
                className: 'count-label',
                html: `<div>${تعداد} قطعه</div>`,
                iconSize: [100, 20],
                iconAnchor: [50, 10]
            });
            
            const برچسب_مارکر = L.marker(مرکز, { icon: برچسب_آیکون, interactive: false });
            لایه_تعداد_ها.addLayer(برچسب_مارکر);
        }


        // تابع برای بارگذاری فایل‌های GeoJSON
        async function بارگذاری_geojson(آدرس, نام) {
            try {
                const پاسخ = await fetch(آدرس);
                if (!پاسخ.ok) {
                    throw new Error(`HTTP error! status: ${پاسخ.status}`);
                }
                return await پاسخ.json();
            } catch (خطا) {
                console.error(`خطا در بارگذاری GeoJSON از ${آدرس}:`, خطا);
                return null;
            }
        }

        // تابع اصلی برای بارگذاری داده‌ها و نمایش روی نقشه
        document.addEventListener('DOMContentLoaded', async () => {
            // آدرس فایل‌های GeoJSON را اینجا وارد کنید
            const آدرس_محلات = 'mahalatfarsodeh.geojson'; 
            const آدرس_نوسازی = 'nosazi.geojson';

            const داده_محلات = await بارگذاری_geojson(آدرس_محلات, 'اطلاعات محلات');
            const داده_نوسازی = await بارگذاری_geojson(آدرس_نوسازی, 'اطلاعات نوسازی');
            
            // محاسبه تعداد قطعات نوسازی شده برای هر محله
            const تعداد_محلات = {};
            if (داده_نوسازی && داده_محلات) {
                داده_نوسازی.features.forEach(قطعه => {
                    const نقطه = turf.point(قطعه.geometry.coordinates);
                    داده_محلات.features.forEach(محله => {
                        if (turf.booleanPointInPolygon(نقطه, محله.geometry)) {
                            const نام_محله = محله.properties.name;
                            تعداد_محلات[نام_محله] = (تعداد_محلات[نام_محله] || 0) + 1;
                        }
                    });
                });
            }


            // ایجاد یک گروه برای خوشه بندی (Marker Cluster Group)
            const گروه_خوشه_ها = L.markerClusterGroup({
                maxClusterRadius: 80, // تنظیم شعاع خوشه ها
                disableClusteringAtZoom: 16, // خاموش کردن خوشه بندی در زوم بالا
                // سفارشی کردن آیکون خوشه
                iconCreateFunction: function(خوشه) {
                    const تعداد_مارکرها = خوشه.getChildCount();
                    let اندازه = 'small';
                    let رنگ = '#0054ff'; // رنگ پیشفرض
                    
                    if (تعداد_مارکرها < 10) {
                        اندازه = 'small';
                        رنگ = '#0054ff';
                    } else if (تعداد_مارکرها < 100) {
                        اندازه = 'medium';
                        رنگ = '#ff9900';
                    } else {
                        اندازه = 'large';
                        رنگ = '#ff0000';
                    }

                    const html_content = `<div class="cluster-icon-${اندازه}" style="background-color:${رنگ}; color: white; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 1rem; border-radius: 50%; box-shadow: 0 2px 5px rgba(0,0,0,0.3); width: 40px; height: 40px;">${تعداد_مارکرها}</div>`;
                    
                    return L.divIcon({
                        html: html_content,
                        className: 'custom-cluster-icon',
                        iconSize: L.point(40, 40)
                    });
                }
            });

            // نمایش لایه محلات اگر داده‌ها وجود داشته باشد
            if (داده_محلات) {
                لایه_چندضلعی_ها = L.geoJSON(داده_محلات, {
                    style: function(ویژگی) {
                        const نام = ویژگی.properties.name;
                        if (!رنگهای_محلات[نام]) {
                            رنگهای_محلات[نام] = رنگها_پیشفرض[شاخص_رنگ % رنگها_پیشفرض.length];
                            شاخص_رنگ++;
                        }
                        return {
                            fillColor: رنگهای_محلات[نام],
                            weight: 2,
                            opacity: 1,
                            color: 'white',
                            fillOpacity: 0.5
                        };
                    },
                    onEachFeature: function(ویژگی, لایه) {
                        if (ویژگی.properties && ویژگی.properties.name) {
                            لایه.bindPopup(`<strong>نام محله:</strong> ${ویژگی.properties.name}`);
                            ایجاد_برچسب_محله(ویژگی);
                            const نام_محله = ویژگی.properties.name;
                            const مرکز = turf.center(ویژگی.geometry);
                            const مختصات = [مرکز.geometry.coordinates[1], مرکز.geometry.coordinates[0]];
                            ایجاد_برچسب_تعداد(نام_محله, تعداد_محلات[نام_محله] || 0, مختصات);
                        }
                    }
                }).addTo(نقشه);

                نقشه.fitBounds(لایه_چندضلعی_ها.getBounds());
            }

            // نمایش لایه نقاط نوسازی اگر داده‌ها وجود داشته باشد
            if (داده_نوسازی) {
                لایه_نقاط = L.geoJSON(داده_نوسازی, {
                    pointToLayer: function(ویژگی, مختصات) {
                        // از تابع ایجاد_آیکون_سال برای ساخت مارکر با اندازه پویا استفاده می‌کنیم
                        return L.marker(مختصات, { icon: ایجاد_آیکون_سال(ویژگی, نقشه.getZoom()) });
                    },
                    onEachFeature: function(ویژگی, لایه) {
                        if (ویژگی.properties) {
                             const props = ویژگی.properties;
                             const محتوای_پاپ_آپ = `
                                <div class="popup-content">
                                    <div class="popup-title">اطلاعات ملک</div>
                                    <ul class="popup-info-list">
                                        <li class="popup-info-item">
                                            <span class="popup-label flex items-center">
                                                <svg xmlns="http://www.w3.org/2000/svg" class="popup-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                    <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                                                    <line x1="16" y1="2" x2="16" y2="6"></line>
                                                    <line x1="8" y1="2" x2="8" y2="6"></line>
                                                    <line x1="3" y1="10" x2="21" y2="10"></line>
                                                </svg>
                                                سال نوسازی:
                                            </span>
                                            <span class="popup-value">${props.year || 'نامشخص'}</span>
                                        </li>
                                        <li class="popup-info-item">
                                            <span class="popup-label flex items-center">
                                                <svg xmlns="http://www.w3.org/2000/svg" class="popup-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                    <path d="M12 2L2 7v10l10 5 10-5V7L12 2z"></path>
                                                    <polyline points="2 7 12 12 22 7"></polyline>
                                                    <polyline points="2 17 12 22 22 17"></polyline>
                                                </svg>
                                                کاربری ملک:
                                            </span>
                                            <span class="popup-value">${props.توصیح || 'نامشخص'}</span>
                                        </li>
                                        <li class="popup-info-item">
                                            <span class="popup-label flex items-center">
                                                <svg xmlns="http://www.w3.org/2000/svg" class="popup-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                    <rect x="1" y="3" width="15" height="18"></rect>
                                                    <rect x="6" y="8" width="15" height="18"></rect>
                                                    <line x1="21" y1="6" x2="21" y2="24"></line>
                                                </svg>
                                                تعداد طبقات:
                                            </span>
                                            <span class="popup-value">${props['تعدا-۱'] || 'نامشخص'}</span>
                                        </li>
                                        <li class="popup-info-item">
                                            <span class="popup-label flex items-center">
                                                <svg xmlns="http://www.w3.org/2000/svg" class="popup-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                    <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                                                    <circle cx="9" cy="7" r="4"></circle>
                                                    <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                                                    <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                                                </svg>
                                                تعداد واحد:
                                            </span>
                                            <span class="popup-value">${props.تعداد || 'نامشخص'}</span>
                                        </li>
                                    </ul>
                                </div>`;
                            لایه.bindPopup(محتوای_پاپ_آپ);
                        }
                    }
                });
                
                // اضافه کردن لایه نقاط به گروه خوشه ها
                گروه_خوشه_ها.addLayer(لایه_نقاط);
                
                // اضافه کردن گروه خوشه ها به نقشه
                نقشه.addLayer(گروه_خوشه_ها);
            }

            // اضافه کردن کنترل لایه‌ها
            const نقشه_لایه_های_اضافی = {};
            if (لایه_چندضلعی_ها) {
                نقشه_لایه_های_اضافی["محلات"] = لایه_چندضلعی_ها;
            }
            if (گروه_خوشه_ها) {
                نقشه_لایه_های_اضافی["قطعات نوسازی شده"] = گروه_خوشه_ها;
            }
            if (Object.keys(نقشه_لایه_های_اضافی).length > 0) {
                L.control.layers(null, نقشه_لایه_های_اضافی, { collapsed: false }).addTo(نقشه);
            }


            // بروزرسانی اندازه مارکرها و نمایش/پنهان کردن برچسب‌ها هنگام زوم کردن
            نقشه.on('zoomend', function() {
                const زوم_فعلی = نقشه.getZoom();
                
                // بروزرسانی اندازه مارکرها
                if (لایه_نقاط) {
                    لایه_نقاط.eachLayer(function (لایه) {
                         const آیکون_جدید = ایجاد_آیکون_سال(لایه.feature, زوم_فعلی);
                         لایه.setIcon(آیکون_جدید);
                    });
                }
                
                // تنظیم opacity و کلاس CSS برای برچسب‌های محلات
                لایه_برچسب_ها.eachLayer(function(لایه) {
                    const opacity = Math.min(1, Math.max(0.2, (زوم_فعلی - 12) / 3)); // با تغییر زوم از ۱۲ تا ۱۵، شفافیت از ۰.۲ به ۱ افزایش می‌یابد
                    لایه.getElement().style.opacity = opacity;
                });
                
                // نمایش/پنهان کردن برچسب‌های تعداد
                // از زوم ۱۶ به بالا، برچسب‌های تعداد حذف می‌شوند تا آیکون‌ها نمایان شوند
                if (زوم_فعلی >= 15 && زوم_فعلی < 16) {
                    if (!نقشه.hasLayer(لایه_تعداد_ها)) {
                        نقشه.addLayer(لایه_تعداد_ها);
                    }
                } else {
                    if (نقشه.hasLayer(لایه_تعداد_ها)) {
                        نقشه.removeLayer(لایه_تعداد_ها);
                    }
                }
            });
            
            // نمایش اولیه برچسب‌های محلات و تعداد
            نقشه.addLayer(لایه_برچسب_ها);
            if (نقشه.getZoom() >= 15 && نقشه.getZoom() < 16) {
                نقشه.addLayer(لایه_تعداد_ها);
            }
        });
    </script>
</body>
</html>
